jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven


      - name: Ensure Docker is reachable (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          DOCKER_HOST: 'npipe:////./pipe/dockerDesktopLinuxEngine'
        run: |
          $ErrorActionPreference = "Stop"
          # zkusit nastartovat službu Docker Desktop (pokud existuje)
          try { Get-Service com.docker.service -ErrorAction Stop | Start-Service } catch {}
          # počkat, než bude docker odpovídat
          for ($i=0; $i -lt 30; $i++) {
            try { docker version; break } catch { Start-Sleep -Seconds 2 }
            if ($i -eq 29) { throw "Docker is not reachable." }
          }

      - name: Build app with Maven
        run: mvn -B clean install -DskipTests

      - name: Deploy using Docker Compose
        env:
          DOCKER_HOST: 'npipe:////./pipe/dockerDesktopLinuxEngine'
        run: |
          docker compose down || echo "Nothing to stop"
          docker compose up -d --build
